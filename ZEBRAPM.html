<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zebra Project Manager</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo personalizado para la barra de desplazamiento en los listados */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Colores especÃ­ficos para el tema blanco/negro/rojo */
        .text-red-600 { color: #DC2626; }
        .bg-red-600 { background-color: #DC2626; }
        .hover\:bg-red-700:hover { background-color: #B91C1C; }
        .focus\:ring-red-500:focus { --tw-ring-color: #EF4444; }
        .border-red-400 { border-color: #F87171; }
        .bg-red-50 { background-color: #FEF2F2; } /* Un rojo muy claro para fondos */
        .text-red-800 { color: #991B1B; }
        .bg-red-900 { background-color: #7F1D1D; }
        .border-red-700 { border-color: #B91C1C; }
        .text-red-100 { color: #FEE2E2; }
        .text-red-300 { color: #FCA5A5; }
        .bg-red-900 { background-color: #7F1D1D; } /* Para la alerta de tareas vencidas */
        .border-red-700 { border-color: #B91C1C; }
    </style>
    <!-- React & ReactDOM CDN (development versions) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel CDN for JSX transformation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDKs CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase (will be populated in the React script)
        window.firebaseApp = null;
        window.firestoreDb = null;
        window.firebaseAuth = null;
        window.appId = 'default-project-app'; // Default app ID

        // Placeholder for firebaseConfig. In a real environment, this would come from your Firebase project settings.
        // For local testing, you can replace this with your actual Firebase config object:
        // const firebaseConfig = {
        //   apiKey: "YOUR_API_KEY",
        //   authDomain: "YOUR_AUTH_DOMAIN",
        //   projectId: "YOUR_PROJECT_ID",
        //   storageBucket: "YOUR_STORAGE_BUCKET",
        //   messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        //   appId: "YOUR_APP_ID"
        // };
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Reemplaza con tu clave API de Firebase
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "your-sender-id",
            appId: "your-app-id"
        };


        // Initialize Firebase services globally
        window.firebaseApp = initializeApp(firebaseConfig);
        window.firestoreDb = getFirestore(window.firebaseApp);
        window.firebaseAuth = getAuth(window.firebaseApp);

        // Simulate __initial_auth_token from Canvas environment
        // In a real deployed app, you'd manage user authentication more robustly.
        const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

        if (__initial_auth_token) {
            signInWithCustomToken(window.firebaseAuth, __initial_auth_token)
                .catch(error => console.error("Error signing in with custom token:", error));
        } else {
            signInAnonymously(window.firebaseAuth)
                .catch(error => console.error("Error signing in anonymously:", error));
        }

        // Expose Firebase objects globally for the React script to access
        window.db = window.firestoreDb;
        window.auth = window.firebaseAuth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
    </script>
</head>
<body class="font-inter">
    <div id="root"></div>

    <script type="text/babel">
        // Ensure React is available globally after CDN load
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        // Componente para el modal del Diagrama de Gantt
        const GanttModal = ({ tasks, projectName, onClose }) => {
            let minDate = new Date();
            let maxDate = new Date();

            const tasksWithDates = tasks.filter(task => task.startDate && task.endDate);

            if (tasksWithDates.length > 0) {
                minDate = tasksWithDates[0].startDate.toDate();
                maxDate = tasksWithDates[0].endDate.toDate();

                tasksWithDates.forEach(task => {
                    const start = task.startDate.toDate();
                    const end = task.endDate.toDate();
                    if (start < minDate) minDate = start;
                    if (end > maxDate) maxDate = end;
                });
            } else {
                minDate = new Date();
                maxDate = new Date();
                maxDate.setDate(minDate.getDate() + 30);
            }

            minDate.setDate(minDate.getDate() - 5);
            maxDate.setDate(maxDate.getDate() + 5);

            const oneDay = 24 * 60 * 60 * 1000;
            const totalDays = Math.ceil(Math.abs((maxDate.getTime() - minDate.getTime()) / oneDay));

            const SVG_WIDTH = 900;
            const SVG_HEIGHT_PER_TASK = 60;
            const HEADER_HEIGHT = 60;
            const LEFT_OFFSET = 180;
            const barHeight = 25;

            const totalSvgHeight = HEADER_HEIGHT + (tasksWithDates.length * SVG_HEIGHT_PER_TASK) + 20;
            const pixelsPerDay = (SVG_WIDTH - LEFT_OFFSET) / totalDays;

            const getXPos = (date) => {
                if (!date) return LEFT_OFFSET;
                const diffDays = Math.round(Math.abs((date.getTime() - minDate.getTime()) / oneDay));
                return LEFT_OFFSET + (diffDays * pixelsPerDay);
            };

            const getDateLabels = () => {
                const labels = [];
                let currentDate = new Date(minDate);
                while (currentDate <= maxDate) {
                    labels.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() + 7);
                }
                return labels;
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col text-gray-800">
                        {/* Encabezado del Modal */}
                        <div className="flex justify-between items-center pb-4 border-b border-gray-300 mb-4">
                            <h3 className="text-2xl font-bold text-red-600">Diagrama de Gantt: {projectName}</h3>
                            <button
                                onClick={onClose}
                                className="p-2 rounded-full hover:bg-gray-100 text-gray-500 hover:text-gray-700 transition duration-200"
                                title="Cerrar"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        {/* Contenido del Diagrama de Gantt */}
                        {tasksWithDates.length === 0 ? (
                            <p className="text-center text-gray-500 py-8">No hay tareas con fechas de inicio y fin para mostrar en el Diagrama de Gantt.</p>
                        ) : (
                            <div className="overflow-x-auto overflow-y-auto flex-grow custom-scrollbar" style={{ maxHeight: 'calc(90vh - 120px)' }}>
                                <svg width={SVG_WIDTH} height={totalSvgHeight} className="bg-gray-100 border border-gray-300 rounded-lg min-w-full">
                                    {/* Vertical grid lines for weeks */}
                                    <g className="gantt-grid-lines">
                                        {getDateLabels().map((date, index) => (
                                            <line
                                                key={`grid-line-${index}`}
                                                x1={getXPos(date)}
                                                y1={0}
                                                x2={getXPos(date)}
                                                y2={totalSvgHeight}
                                                stroke="#E0E0E0"
                                                strokeWidth="1"
                                                strokeDasharray="4 4"
                                            />
                                        ))}
                                    </g>

                                    {/* Date header */}
                                    <g className="gantt-header">
                                        {getDateLabels().map((date, index) => (
                                            <text
                                                key={`header-date-${index}`}
                                                x={getXPos(date)}
                                                y={HEADER_HEIGHT / 2}
                                                fill="#6B7280"
                                                fontSize="10"
                                                textAnchor="middle"
                                            >
                                                {date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' })}
                                            </text>
                                        ))}
                                    </g>

                                    {/* Task rows */}
                                    <g className="gantt-tasks">
                                        {tasksWithDates.map((task, index) => {
                                            const taskY = HEADER_HEIGHT + (index * SVG_HEIGHT_PER_TASK) + (SVG_HEIGHT_PER_TASK - barHeight) / 2;
                                            const startX = getXPos(task.startDate.toDate());
                                            const endX = getXPos(task.endDate.toDate());
                                            const barWidth = Math.max(1, endX - startX);

                                            const fillColor = task.completed ? '#4ADE80' : '#DC2626';

                                            return (
                                                <g key={task.id}>
                                                    {/* Task name */}
                                                    <text x="10" y={taskY + barHeight / 2 - 5} fill="#333" fontSize="12" className="font-medium">
                                                        {task.name}
                                                    </text>
                                                    {/* Task responsible */}
                                                    {task.responsible && (
                                                        <text x="10" y={taskY + barHeight / 2 + 10} fill="#6B7280" fontSize="10">
                                                            ({task.responsible})
                                                        </text>
                                                    )}

                                                    {/* Gantt bar */}
                                                    <rect
                                                        x={startX}
                                                        y={taskY}
                                                        width={barWidth}
                                                        height={barHeight}
                                                        fill={fillColor}
                                                        rx="3" ry="3"
                                                        className="transition-all duration-300 ease-out"
                                                        title={`${task.name} (${task.startDate.toDate().toLocaleDateString()} - ${task.endDate.toDate().toLocaleDateString()})`}
                                                    />
                                                </g>
                                            );
                                        })}
                                    </g>
                                </svg>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Main application component
        const App = () => {
            // Define the application ID, using a global variable if it exists, otherwise a default value
            const appId = typeof window.appId !== 'undefined' ? window.appId : 'default-project-app';

            // Application states
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [projects, setProjects] = useState([]);
            const [selectedProjectId, setSelectedProjectId] = useState(null);
            const [tasks, setTasks] = useState([]);
            const [newProjectName, setNewProjectName] = useState('');
            const [newTaskName, setNewTaskName] = useState('');
            const [newTaskResponsible, setNewTaskResponsible] = useState('');
            const [newTaskStartDate, setNewTaskStartDate] = useState('');
            const [newTaskEndDate, setNewTaskEndDate] = useState('');
            const [loading, setLoading] = useState(true);
            const [authReady, setAuthReady] = useState(false);
            const [showGanttModal, setShowGanttModal] = useState(false);
            const [showOverdueAlert, setShowOverdueAlert] = useState(false);
            const [projectNotes, setProjectNotes] = useState('');

            // Firebase initialization and authentication
            useEffect(() => {
                const initFirebaseClients = async () => {
                    try {
                        // Access global Firebase instances
                        setDb(window.db);
                        setAuth(window.auth);

                        // Listen for authentication state changes
                        const unsubscribe = window.onAuthStateChanged(window.auth, (user) => {
                            if (user) {
                                setUserId(user.uid);
                            } else {
                                // Fallback for anonymous login if custom token not provided
                                window.firebase.auth().signInAnonymously()
                                    .then(anonUser => setUserId(anonUser.user.uid))
                                    .catch(error => console.error("Error signing in anonymously:", error));
                            }
                            setAuthReady(true);
                            setLoading(false);
                        });

                        return () => unsubscribe();
                    } catch (error) {
                        console.error("Error initializing Firebase clients:", error);
                        setLoading(false);
                    }
                };

                initFirebaseClients();
            }, [appId]); // Re-run if appId changes

            // Listen for project changes
            useEffect(() => {
                if (!db || !userId || !authReady) return;

                setLoading(true);
                const projectsCollectionRef = window.collection(db, `artifacts/${appId}/users/${userId}/projects`);
                const q = window.query(projectsCollectionRef);

                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    const projectsData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    projectsData.sort((a, b) => (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0));
                    setProjects(projectsData);
                    setLoading(false);
                }, (error) => {
                    console.error("Error al obtener proyectos:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [db, userId, authReady, appId]);

            // Listen for changes in tasks of the selected project
            useEffect(() => {
                if (!db || !userId || !selectedProjectId || !authReady) {
                    setTasks([]);
                    setProjectNotes('');
                    setShowOverdueAlert(false);
                    return;
                }

                setLoading(true);
                const tasksCollectionRef = window.collection(db, `artifacts/${appId}/users/${userId}/projects/${selectedProjectId}/tasks`);
                const q = window.query(tasksCollectionRef);

                const unsubscribeTasks = window.onSnapshot(q, (snapshot) => {
                    const currentTimestamp = new Date();
                    let hasOverdueTasks = false;

                    const tasksData = snapshot.docs.map(doc => {
                        const task = {
                            id: doc.id,
                            ...doc.data()
                        };
                        if (!task.completed && task.endDate && task.endDate.toDate() < currentTimestamp) {
                            hasOverdueTasks = true;
                        }
                        return task;
                    });

                    tasksData.sort((a, b) => {
                        if (a.completed === b.completed) {
                            return (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0);
                        }
                        return a.completed ? 1 : -1;
                    });
                    setTasks(tasksData);
                    setShowOverdueAlert(hasOverdueTasks);
                    setLoading(false);
                }, (error) => {
                    console.error("Error al obtener tareas:", error);
                    setLoading(false);
                    setShowOverdueAlert(false);
                });

                const projectDocRef = window.doc(db, `artifacts/${appId}/users/${userId}/projects`, selectedProjectId);
                const unsubscribeProject = window.onSnapshot(projectDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setProjectNotes(docSnap.data().notes || '');
                    } else {
                        setProjectNotes('');
                    }
                }, (error) => {
                    console.error("Error al obtener notas del proyecto:", error);
                    setProjectNotes('');
                });

                return () => {
                    unsubscribeTasks();
                    unsubscribeProject();
                };
            }, [db, userId, selectedProjectId, authReady, appId]);

            // Function to add a new project
            const addProject = async () => {
                if (!db || !userId || newProjectName.trim() === '') return;

                try {
                    await window.addDoc(window.collection(db, `artifacts/${appId}/users/${userId}/projects`), {
                        name: newProjectName.trim(),
                        notes: '',
                        createdAt: new Date(),
                        completedTasks: 0,
                        totalTasks: 0
                    });
                    setNewProjectName('');
                } catch (e) {
                    console.error("Error al aÃ±adir proyecto:", e);
                }
            };

            // Function to add a new task
            const addTask = async () => {
                if (!db || !userId || !selectedProjectId || newTaskName.trim() === '') return;

                try {
                    await window.addDoc(window.collection(db, `artifacts/${appId}/users/${userId}/projects/${selectedProjectId}/tasks`), {
                        name: newTaskName.trim(),
                        completed: false,
                        responsible: newTaskResponsible.trim(),
                        startDate: newTaskStartDate ? new Date(newTaskStartDate) : null,
                        endDate: newTaskEndDate ? new Date(newTaskEndDate) : null,
                        createdAt: new Date()
                    });

                    const projectRef = window.doc(db, `artifacts/${appId}/users/${userId}/projects`, selectedProjectId);
                    await window.updateDoc(projectRef, {
                        totalTasks: (tasks.length + 1)
                    });

                    setNewTaskName('');
                    setNewTaskResponsible('');
                    setNewTaskStartDate('');
                    setNewTaskEndDate('');
                } catch (e) {
                    console.error("Error al aÃ±adir tarea:", e);
                }
            };

            // Function to toggle task completed status
            const toggleTaskCompleted = async (taskId, currentCompleted) => {
                if (!db || !userId || !selectedProjectId) return;

                try {
                    const taskRef = window.doc(db, `artifacts/${appId}/users/${userId}/projects/${selectedProjectId}/tasks`, taskId);
                    await window.updateDoc(taskRef, {
                        completed: !currentCompleted
                    });

                    const projectRef = window.doc(db, `artifacts/${appId}/users/${userId}/projects`, selectedProjectId);
                    const updatedCompletedCount = !currentCompleted ? tasks.filter(t => t.completed).length + 1 : tasks.filter(t => t.completed).length - 1;
                    await window.updateDoc(projectRef, {
                        completedTasks: updatedCompletedCount
                    });

                } catch (e) {
                    console.error("Error al actualizar tarea:", e);
                }
            };

            // Function to delete a task
            const deleteTask = async (taskId) => {
                if (!db || !userId || !selectedProjectId) return;

                try {
                    const taskToDelete = tasks.find(task => task.id === taskId);
                    await window.deleteDoc(window.doc(db, `artifacts/${appId}/users/${userId}/projects/${selectedProjectId}/tasks`, taskId));

                    const projectRef = window.doc(db, `artifacts/${appId}/users/${userId}/projects`, selectedProjectId);
                    const currentTotalTasks = tasks.length;
                    const currentCompletedTasks = tasks.filter(t => t.completed).length;

                    await window.updateDoc(projectRef, {
                        totalTasks: currentTotalTasks - 1,
                        completedTasks: taskToDelete.completed ? currentCompletedTasks - 1 : currentCompletedTasks
                    });

                } catch (e) {
                    console.error("Error al eliminar tarea:", e);
                }
            };

            // Function to update project notes in Firestore
            const updateProjectNotes = async () => {
                if (!db || !userId || !selectedProjectId) return;
                try {
                    const projectRef = window.doc(db, `artifacts/${appId}/users/${userId}/projects`, selectedProjectId);
                    await window.updateDoc(projectRef, {
                        notes: projectNotes
                    });
                    console.log("Notas del proyecto guardadas.");
                } catch (e) {
                    console.error("Error al guardar las notas del proyecto:", e);
                }
            };

            // Calculate project progress percentage
            const calculateProjectProgress = (project) => {
                if (!project || project.totalTasks === 0) {
                    return 0;
                }
                return Math.round((project.completedTasks / project.totalTasks) * 100);
            };

            // User interface
            return (
                <div className="min-h-screen bg-white p-4 font-inter text-gray-800">
                    {/* Main application container */}
                    <div className="max-w-6xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden md:flex">
                        {/* Projects Panel (left sidebar) */}
                        <div className="w-full md:w-1/3 p-6 bg-gray-50 text-gray-800 flex flex-col justify-between border-r border-gray-200">
                            <div>
                                <h1 className="text-3xl font-extrabold mb-6 flex items-center">
                                    {/* Zebra Image */}
                                    <img
                                        src="https://placehold.co/40x40/000/FFF/png?text=ðŸ¦“"
                                        alt="Icono de Zebra"
                                        className="h-8 w-8 mr-3 rounded-full"
                                        onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/40x40/000/FFF?text=Z"; }}
                                    />
                                    Zebra Project Manager
                                </h1>
                                {/* Display User ID */}
                                {userId && (
                                    <p className="text-sm opacity-80 mb-4 break-words">
                                        ID de Usuario: <span className="font-mono text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded">{userId}</span>
                                    </p>
                                )}

                                {/* Form to add new project */}
                                <div className="mb-6">
                                    <input
                                        type="text"
                                        placeholder="Nombre del nuevo proyecto"
                                        className="w-full p-3 rounded-lg bg-white text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-red-500 mb-2 border border-gray-300"
                                        value={newProjectName}
                                        onChange={(e) => setNewProjectName(e.target.value)}
                                        onKeyPress={(e) => { if (e.key === 'Enter') addProject(); }}
                                    />
                                    <button
                                        onClick={addProject}
                                        className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 transform hover:scale-105 shadow-md"
                                    >
                                        AÃ±adir Proyecto
                                    </button>
                                </div>

                                {/* Projects List */}
                                <h2 className="text-xl font-semibold mb-4 border-b border-gray-300 pb-2">Mis Proyectos</h2>
                                {loading && !authReady ? (
                                    <p className="text-center text-gray-500">Cargando...</p>
                                ) : projects.length === 0 ? (
                                    <p className="text-center text-gray-500">No hay proyectos todavÃ­a. Â¡AÃ±ade uno!</p>
                                ) : (
                                    <ul className="space-y-3">
                                        {projects.map((project) => (
                                            <li
                                                key={project.id}
                                                onClick={() => setSelectedProjectId(project.id)}
                                                className={`p-4 rounded-lg cursor-pointer transition duration-200 ease-in-out border border-gray-200 ${
                                                    selectedProjectId === project.id ? 'bg-red-50 shadow-lg border-red-400' : 'bg-white hover:bg-gray-100'
                                                }`}
                                            >
                                                <div className="flex justify-between items-center mb-1">
                                                    <span className="font-medium text-lg truncate pr-2">{project.name}</span>
                                                    {project.totalTasks > 0 && (
                                                        <span className="text-sm bg-gray-200 text-red-600 px-2 py-1 rounded-full">{`${calculateProjectProgress(project)}%`}</span>
                                                    )}
                                                </div>
                                                {project.totalTasks > 0 && (
                                                    <div className="w-full bg-gray-300 rounded-full h-2.5">
                                                        <div
                                                            className="bg-red-500 h-2.5 rounded-full transition-all duration-500 ease-out"
                                                            style={{ width: `${calculateProjectProgress(project)}%` }}
                                                        ></div>
                                                    </div>
                                                )}
                                                {project.totalTasks === 0 && (
                                                    <p className="text-sm opacity-70 text-gray-600">Sin tareas.</p>
                                                )}
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                            <footer className="mt-8 text-center text-sm opacity-70 text-gray-600">
                                Â© {new Date().getFullYear()} Zebra Project Manager. Todos los derechos reservados.
                            </footer>
                        </div>

                        {/* Tasks Panel (main content on the right) */}
                        <div className="w-full md:w-2/3 p-8 bg-white flex flex-col text-gray-800">
                            {selectedProjectId ? (
                                <>
                                    {/* Selected project header with Gantt button */}
                                    <h2 className="text-3xl font-extrabold text-red-600 mb-6 pb-3 border-b-2 border-gray-200 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-7 w-7 mr-3 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                                        </svg>
                                        {projects.find(p => p.id === selectedProjectId)?.name || 'Cargando Proyecto...'}
                                        <button
                                            onClick={() => setShowGanttModal(true)}
                                            className="ml-auto bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg text-sm shadow-md transition duration-300 transform hover:scale-105"
                                        >
                                            Ver Diagrama de Gantt
                                        </button>
                                    </h2>

                                    {/* Overdue tasks alert */}
                                    {showOverdueAlert && (
                                        <div className="bg-red-100 border border-red-400 text-red-800 px-4 py-3 rounded-lg relative mb-4">
                                            <strong className="font-bold">Â¡AtenciÃ³n!</strong>
                                            <span className="block sm:inline ml-2">Hay tareas vencidas en este proyecto.</span>
                                            <span className="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onClick={() => setShowOverdueAlert(false)}>
                                                <svg className="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Cerrar</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
                                            </span>
                                        </div>
                                    )}

                                    {/* Project Notes Section */}
                                    <div className="mb-8">
                                        <h3 className="text-xl font-semibold text-gray-700 mb-2">Notas del Proyecto</h3>
                                        <textarea
                                            className="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 bg-white text-gray-800"
                                            rows="4"
                                            placeholder="Agrega notas generales para este proyecto aquÃ­..."
                                            value={projectNotes}
                                            onChange={(e) => setProjectNotes(e.target.value)}
                                            onBlur={updateProjectNotes}
                                        ></textarea>
                                    </div>

                                    {/* Form to add new task */}
                                    <div className="mb-8 space-y-3">
                                        <input
                                            type="text"
                                            placeholder="Nombre de la nueva tarea"
                                            className="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 bg-white text-gray-800"
                                            value={newTaskName}
                                            onChange={(e) => setNewTaskName(e.target.value)}
                                            onKeyPress={(e) => { if (e.key === 'Enter') addTask(); }}
                                        />
                                        <input
                                            type="text"
                                            placeholder="Responsable de la tarea"
                                            className="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 bg-white text-gray-800"
                                            value={newTaskResponsible}
                                            onChange={(e) => setNewTaskResponsible(e.target.value)}
                                            onKeyPress={(e) => { if (e.key === 'Enter') addTask(); }}
                                        />
                                        <div className="flex space-x-2">
                                            <input
                                                type="date"
                                                title="Fecha de Inicio"
                                                className="w-1/2 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 bg-white text-gray-800"
                                                value={newTaskStartDate}
                                                onChange={(e) => setNewTaskStartDate(e.target.value)}
                                            />
                                            <input
                                                type="date"
                                                title="Fecha de TerminaciÃ³n"
                                                className="w-1/2 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 bg-white text-gray-800"
                                                value={newTaskEndDate}
                                                onChange={(e) => setNewTaskEndDate(e.target.value)}
                                            />
                                        </div>
                                        <button
                                            onClick={addTask}
                                            className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300 transform hover:scale-105 shadow-md"
                                        >
                                            AÃ±adir Tarea
                                        </button>
                                    </div>

                                    {/* Tasks List */}
                                    {loading ? (
                                        <p className="text-center text-gray-500">Cargando tareas...</p>
                                    ) : tasks.length === 0 ? (
                                        <p className="text-center text-gray-500 mt-8">Este proyecto no tiene tareas todavÃ­a. Â¡AÃ±ade una!</p>
                                    ) : (
                                        <ul className="space-y-4 flex-grow overflow-y-auto pr-2 custom-scrollbar">
                                            {tasks.map((task) => {
                                                const isOverdue = !task.completed && task.endDate && task.endDate.toDate() < new Date();
                                                return (
                                                    <li
                                                        key={task.id}
                                                        className={`flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 rounded-lg shadow-sm transition duration-150 ease-in-out border border-gray-200
                                                        ${isOverdue ? 'bg-red-50 border-red-400' : 'bg-white hover:bg-gray-100'}`}
                                                    >
                                                        <div className="flex items-center flex-grow mb-2 sm:mb-0">
                                                            <input
                                                                type="checkbox"
                                                                checked={task.completed}
                                                                onChange={() => toggleTaskCompleted(task.id, task.completed)}
                                                                className="form-checkbox h-5 w-5 text-red-600 rounded focus:ring-red-500 transition duration-150 ease-in-out cursor-pointer"
                                                            />
                                                            <span className={`ml-3 text-lg font-medium ${task.completed ? 'line-through text-gray-500' : 'text-gray-800'}`}>
                                                                {task.name}
                                                            </span>
                                                        </div>
                                                        <div className="flex flex-col sm:flex-row sm:items-center text-sm text-gray-600 sm:ml-4">
                                                            {task.responsible && (
                                                                <span className="bg-gray-200 text-red-600 px-2 py-1 rounded-full mr-2 mb-1 sm:mb-0">
                                                                    Responsable: {task.responsible}
                                                                </span>
                                                            )}
                                                            {task.startDate && (
                                                                <span className="bg-gray-200 text-red-600 px-2 py-1 rounded-full mr-2 mb-1 sm:mb-0">
                                                                    Inicio: {task.startDate.toDate().toLocaleDateString()}
                                                                </span>
                                                            )}
                                                            {task.endDate && (
                                                                <span className="bg-gray-200 text-red-600 px-2 py-1 rounded-full mr-2 mb-1 sm:mb-0">
                                                                    Fin: {task.endDate.toDate().toLocaleDateString()}
                                                                </span>
                                                            )}
                                                            <button
                                                                onClick={() => deleteTask(task.id)}
                                                                className="ml-0 sm:ml-4 p-2 rounded-full text-red-500 hover:bg-gray-100 transition duration-200"
                                                                title="Eliminar Tarea"
                                                            >
                                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </li>
                                                );
                                            })}
                                        </ul>
                                    )}
                                </>
                            ) : (
                                <div className="flex flex-col items-center justify-center h-full text-gray-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-24 w-24 mb-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M11 4a2 2 0 10-4 0v1a1 1 0 001 1h3a1 1 0 001-1V4zm0 16a2 2 0 10-4 0v1a1 1 0 001 1h3a1 1 0 001-1v-1zm-1-7h2m-4 0h4m-9 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2z" />
                                    </svg>
                                    <p className="text-xl font-semibold">Selecciona un proyecto para ver sus tareas</p>
                                    <p className="mt-2">O crea un nuevo proyecto a la izquierda.</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Gantt Diagram Modal */}
                    {showGanttModal && (
                        <GanttModal
                            tasks={tasks}
                            projectName={projects.find(p => p.id === selectedProjectId)?.name || 'Proyecto Desconocido'}
                            onClose={() => setShowGanttModal(false)}
                        />
                    )}
                </div>
            );
        };

        // Mount the React application
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
